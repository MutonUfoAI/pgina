<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<!--

	zenlike1.0 by nodethirtythree design
	http://www.nodethirtythree.com

-->
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
<title>pGina fork</title>
<meta name="keywords" content="" />
<meta name="description" content="" />

<link rel="stylesheet" type="text/css" href="https://mutonufoai.github.io/pgina/default_doc.css" />

</head>
<body>

<div id="outer">

	<div id="header">
		<div id="headercontent">
			<h1>pGina fork</h1>
			<h2>Open Source Windows Authentication</h2>
		</div>
		<div id="logo"><a href="https://mutonufoai.github.io/pgina/index.html"><img src="https://mutonufoai.github.io/pgina/images/pginalogo.png" /></a></div>
	</div>

	
	<div id="menu">
		<!-- HINT: Set the class of any menu link below to "active" to make it appear active -->
		<ul>
			<li><a href="https://mutonufoai.github.io/pgina/index.html">Home</a></li>
			<li><a href="https://mutonufoai.github.io/pgina/download.html">Download</a></li>
      <li><a href="https://mutonufoai.github.io/pgina/support.html">Support</a></li>
      <li><a href="https://mutonufoai.github.io/pgina/documentation.html" class="active">Documentation</a></li>
      <li><a href="https://mutonufoai.github.io/pgina/develop.html">Develop</a></li>
      <li><a href="https://mutonufoai.github.io/pgina/faq.html">FAQ</a></li>
      <li><a href="https://mutonufoai.github.io/pgina/thanks.html">Thanks</a></li>
		</ul>
	</div>

	<div id="menubottom"></div>

	<div id="content">
	    
	    
		
			
<h1 id="pgina_core_developer_documentation">pGina Core Developer Documentation</h1>

<h2 id="contents">Contents</h2>

<ul>
<li><a href="#arch">The pGina Architecture</a></li>

<li><a href="#cp">The Credential Provider</a></li>

<li><a href="#service">The pGina Service</a></li>
</ul>
<hr /><h2 id='arch'>The pGina Architecture</h2>
<p>pGina’s architecture is based on three main components: the credential provider/GINA, the pGina service, and the plugins. The image below shows the components and their relationship to eachother.</p>

<p><img src="https://mutonufoai.github.io/pgina/images/documentation/core/pgina_components.png" alt="pGina components" /></p>

<p>The Credential Provider or GINA augments or replaces the default Windows authentication functionality. In Windows Vista or later, this component is called a Credential Provider (CP), in prior versions of Windows, we it is a GINA. More details on each of these options is provided below, suffice it to say for now that this component plugs-in to the Windows authentication system and can configure parts of what is requested (username/ password), and what is displayed (logo, MOTD, etc.). In a standard login, the CP/GINA receives the user’s credentials and passes them along to the pGina Service via a named pipe.</p>

<p>The pGina Service is the core of the pGina system. It recieves the credentials from the CP/GINA and then activates the plugins which are responsible for the authentication, authorization, and other login time actions. The pGina service does no authentication/authorization on its own. Instead, it is up to the plugins to do this work. The pGina service is essentially a “traffic cop” that invokes the plugins in their configured order and determines the overall result based on the results returned by the plugins.</p>

<p>The plugins and the pGina service are both written in C# on the .NET 4.0 platform. The CP/GINA is (and must be) written in unmanged C++. Communication between the CP/GINA and the service is done via a named pipe. The plugins are loaded at startup by the service and enumerated using reflection.</p>
<h2 id='cp'>The Credential Provider</h2>
<p>In Windows Vista and later, in order to provide alternate methods of authentication and/or authorization, one must implement a Credential Provider (CP). The CP can configure the UI that is presented to the user, as well as determine the result of the authentication. A CP is a COM object that is loaded and instantiated by the <code>LogonUI.exe</code> process when a user is presented the opportunity to unlock, login, or otherwise interact with the <code>winlogon.exe</code> process.</p>

<p>The pGina CP is defined within the main code distribution in the directory: <code>pGina/src/CredentialProvider</code>. It consists of two main parts: the provider and the credential (naturally enough). The provider class implements <code>ICredentialProvider</code>. In pGina, this class is named <code>pGina::CredProv::Provider</code> (located in <code>Provider.cpp|h</code>). The credential class implements <code>ICredentialProviderCredential</code> and the pGina implementation is <code>pGina::CredProv::Credential</code> located in <code>Credential.cpp|h</code>.</p>

<p>When initializing a login/unlock/CredUI scenario, the following steps occur:</p>

<ol>
<li>The provider object is told the scenario that it is running under via a call to <code>SetUsageScenario</code>.</li>

<li>The provider is asked about how many credentials it provides via a call to <code>GetCredentialCount</code>. This equates to the number of tiles that you will see in the resulting UI. For example, the default credential provider usually displays one tile for each local user.</li>

<li>The provider is then queried for a <code>ICredentialProviderCredential</code> object for each credential via <code>GetCredentialAt</code>. In this function, we create a <code>Credential</code> object, initialize it, and provide it to the caller (via an output argument). The pGina CP only provides a single credential object.</li>
</ol>

<p>The provider object also defines the number of fields that are presented to the user in the UI. A field is a UI element such as a text-box, image, label, or button, and each field has a name and other properties.<br />All credentials from a given provider (in a given scenario) have the same number of fields as provided by the function <code>GetFieldDescriptorCount</code>. High level details about each field (name, id and type) are provided via <code>GetFieldDescriptorAt</code>.</p>

<p>The credential object provides detailed information about the UI fields via the functions <code>GetFieldState</code> and <code>Get[Type]Value[At]</code>.</p>
<h2 id='service'>The pGina Service</h2>
<p>The Service is a “conductor to guid the orchestra through the login process”. Of course, it does more than that. Its responsible to handle events, catch exceptions, run the plugin chain and storing user data. Communication with plugins is done by pGina.Shared.Interfaces while the CP communicaton is done via a named pipe.</p>

<h3 id="events"><strong>events</strong></h3>

<p>Shutdown events are catched in the ServiceBase.OnCustomCommand method. The service will inform any plugin registred for IPluginLogoffRequestAddTime Interface that a shutdown is going on and polling those plugins by calling LogoffRequestAddTime(), waiting for them to report false.</p>

<p>SessionChange events are captured with a hidden form and passed down to plugins by using the IPluginEventNotifications interface. The SessionChange Method is part of the Service class in pGina.Service.Impl.</p>

<h3 id="exceptions"><strong>exceptions</strong></h3>

<p>If there is an unhandled ecxeption, CurrentDomain_UnhandledException method is called and the exception logged in the pgina log. The service will stop in such a situation. Exceptions from plugins are catched by the service without ending it and the plugin status is set to false.</p>

<h3 id="plugin_chain"><strong>plugin chain</strong></h3>

<p>The plugin chain is called with sessionDriver.PerformLoginProcess() from the HandleLoginRequest method in the Service class of pGina.Service.Impl. Before even doing that HandleLoginRequest will check if it is appropriate to call PerformLoginProcess(). If its an unlock scenario its not necessary also UAC stuff came into account. Its HandleLoginRequest who decide what need to be done with the information delivered from the CP, it also return the status and message of the login to the CP.</p>

<h3 id="user_data"><strong>user data</strong></h3>

<p>Userdata is stored in the private ObjectCache m_sessionPropertyCache in the Service class of pGina.Service.Impl. The key of the dictonary represents the sessionId while the value is a list of SessionProperties. The first entry in the SessionProperties list contains informations about the user who is logged into the session, any other entry is for UAC users. UAC users are programs started by “run as administrator” though the pgina UAC GUI. A lot of methods are reading and writing to m_sessionPropertyCache it is essential to lock this resource if you access it.</p>

<h3 id="communication"><strong>communication</strong></h3>

<p>Communication with plugins is done by pGina.Shared.Interfaces. Depending on the plugin Interface assignment, information is transmited and received to and from plugins. Pipe communication with the CP is defined in Abstractions.Pipes and handled with HandleMessage in the Service class of pGina.Service.Impl. Its a minor communication, basically login status informations or the type of login that is requested.</p>

    
		
		<!-- Secondary content: Stuff that goes in the secondary content column (by default, the narrower right column) -->



	</div>

	<div id="footer">
			<div class="left">&copy; 2017 pgina.org</div>
			<div class="right">Original design by 
			<a href="http://www.nodethirtythree.com/">NodeThirtyThree Design</a></div>
	</div>
	
</div>

</body>
</html>

